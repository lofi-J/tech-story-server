{"version":3,"sources":["../src/main.ts"],"sourcesContent":["import { ValidationPipe } from '@nestjs/common';\nimport { NestFactory } from '@nestjs/core';\nimport session from 'express-session';\nimport { AppModule } from './app.module';\nimport { clientConfig } from './config/app-client-config';\nimport './types/session.types';\n\nasync function bootstrap() {\n  const app = await NestFactory.create(AppModule);\n\n  // Session configuration (build-sync API 제외)\n  const sessionSecret = process.env.SESSION_SECRET;\n  if (!sessionSecret) {\n    console.error('경고: SESSION_SECRET 환경변수가 설정되지 않았습니다!');\n    if (process.env.NODE_ENV === 'production') {\n      throw new Error('SESSION_SECRET 환경변수는 프로덕션에서 필수입니다!');\n    }\n  }\n\n  // 세션 미들웨어를 한 번만 생성\n  const sessionMiddleware = session({\n    secret: sessionSecret || 'dev-fallback-secret-change-in-production',\n    resave: false,\n    saveUninitialized: false,\n    name: 'jera_s',\n    cookie: {\n      secure: process.env.NODE_ENV === 'production',\n      httpOnly: true,\n      maxAge: 6 * 60 * 60 * 1000, // 6 hours\n      sameSite: process.env.NODE_ENV === 'production' ? 'strict' : 'lax',\n    },\n  });\n\n  // build-sync API는 세션 미들웨어에서 제외\n  app.use((req: any, res: any, next: any) => {\n    // eslint-disable-next-line @typescript-eslint/no-unsafe-member-access, @typescript-eslint/no-unsafe-call\n    if (req.path && req.path.startsWith('/api/build-sync/')) {\n      // build-sync API는 세션 없이 진행\n      console.log('build-sync API: 세션 미들웨어 건너뛰기');\n      // eslint-disable-next-line @typescript-eslint/no-unsafe-return, @typescript-eslint/no-unsafe-call\n      return next();\n    }\n\n    // 일반 API는 세션 미들웨어 적용\n    console.log('일반 API: 세션 미들웨어 적용');\n    return sessionMiddleware(req, res, next);\n  });\n\n  // Global validation pipe\n  app.useGlobalPipes(\n    new ValidationPipe({\n      transform: true,\n      whitelist: true,\n      forbidNonWhitelisted: true,\n    }),\n  );\n\n  // app configuration\n  app.enableCors({\n    origin:\n      process.env.NODE_ENV === 'production'\n        ? process.env.FRONTEND_URL || true // 프로덕션에서는 FRONTEND_URL 환경변수 사용, 없으면 모든 origin 허용\n        : [\n            `http://${clientConfig().host}:${clientConfig().port}`,\n            `https://${clientConfig().host}:${clientConfig().port}`,\n          ],\n    methods: ['GET', 'POST', 'PUT', 'DELETE', 'PATCH', 'OPTIONS'],\n    allowedHeaders: [\n      'Content-Type',\n      'Authorization',\n      'Apollo-Require-Preflight',\n    ],\n    credentials: true,\n  });\n\n  await app.listen(process.env.DEFAULT_PORT ?? 3000);\n  console.log(`App is running on port ${process.env.DEFAULT_PORT ?? 3000}`);\n}\nvoid bootstrap();\n"],"names":["bootstrap","app","NestFactory","create","AppModule","sessionSecret","process","env","SESSION_SECRET","console","error","NODE_ENV","Error","sessionMiddleware","session","secret","resave","saveUninitialized","name","cookie","secure","httpOnly","maxAge","sameSite","use","req","res","next","path","startsWith","log","useGlobalPipes","ValidationPipe","transform","whitelist","forbidNonWhitelisted","enableCors","origin","FRONTEND_URL","clientConfig","host","port","methods","allowedHeaders","credentials","listen","DEFAULT_PORT"],"mappings":";;;;wBAA+B;sBACH;uEACR;2BACM;iCACG;QACtB;;;;;;AAEP,eAAeA;IACb,MAAMC,MAAM,MAAMC,iBAAW,CAACC,MAAM,CAACC,oBAAS;IAE9C,4CAA4C;IAC5C,MAAMC,gBAAgBC,QAAQC,GAAG,CAACC,cAAc;IAChD,IAAI,CAACH,eAAe;QAClBI,QAAQC,KAAK,CAAC;QACd,IAAIJ,QAAQC,GAAG,CAACI,QAAQ,KAAK,cAAc;YACzC,MAAM,IAAIC,MAAM;QAClB;IACF;IAEA,mBAAmB;IACnB,MAAMC,oBAAoBC,IAAAA,uBAAO,EAAC;QAChCC,QAAQV,iBAAiB;QACzBW,QAAQ;QACRC,mBAAmB;QACnBC,MAAM;QACNC,QAAQ;YACNC,QAAQd,QAAQC,GAAG,CAACI,QAAQ,KAAK;YACjCU,UAAU;YACVC,QAAQ,IAAI,KAAK,KAAK;YACtBC,UAAUjB,QAAQC,GAAG,CAACI,QAAQ,KAAK,eAAe,WAAW;QAC/D;IACF;IAEA,+BAA+B;IAC/BV,IAAIuB,GAAG,CAAC,CAACC,KAAUC,KAAUC;QAC3B,yGAAyG;QACzG,IAAIF,IAAIG,IAAI,IAAIH,IAAIG,IAAI,CAACC,UAAU,CAAC,qBAAqB;YACvD,2BAA2B;YAC3BpB,QAAQqB,GAAG,CAAC;YACZ,kGAAkG;YAClG,OAAOH;QACT;QAEA,qBAAqB;QACrBlB,QAAQqB,GAAG,CAAC;QACZ,OAAOjB,kBAAkBY,KAAKC,KAAKC;IACrC;IAEA,yBAAyB;IACzB1B,IAAI8B,cAAc,CAChB,IAAIC,sBAAc,CAAC;QACjBC,WAAW;QACXC,WAAW;QACXC,sBAAsB;IACxB;IAGF,oBAAoB;IACpBlC,IAAImC,UAAU,CAAC;QACbC,QACE/B,QAAQC,GAAG,CAACI,QAAQ,KAAK,eACrBL,QAAQC,GAAG,CAAC+B,YAAY,IAAI,KAAK,iDAAiD;WAClF;YACE,CAAC,OAAO,EAAEC,IAAAA,6BAAY,IAAGC,IAAI,CAAC,CAAC,EAAED,IAAAA,6BAAY,IAAGE,IAAI,EAAE;YACtD,CAAC,QAAQ,EAAEF,IAAAA,6BAAY,IAAGC,IAAI,CAAC,CAAC,EAAED,IAAAA,6BAAY,IAAGE,IAAI,EAAE;SACxD;QACPC,SAAS;YAAC;YAAO;YAAQ;YAAO;YAAU;YAAS;SAAU;QAC7DC,gBAAgB;YACd;YACA;YACA;SACD;QACDC,aAAa;IACf;IAEA,MAAM3C,IAAI4C,MAAM,CAACvC,QAAQC,GAAG,CAACuC,YAAY,IAAI;IAC7CrC,QAAQqB,GAAG,CAAC,CAAC,uBAAuB,EAAExB,QAAQC,GAAG,CAACuC,YAAY,IAAI,MAAM;AAC1E;AACA,KAAK9C"}